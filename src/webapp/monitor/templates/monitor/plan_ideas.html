<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Ideas - User Monitoring</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
</head>
<body>

    <!-- 1. Common Navbar -->
    <nav class="navbar" id="mainNav">
        <div class="navbar-brand">LifeMonitor</div>
        <div class="nav-links">
            <a href="{% url 'home' %}" class="nav-item">Home</a>
            <a href="{% url 'settings' %}" class="nav-item">Settings</a>
            <a href="{% url 'logout' %}" class="nav-item btn-logout">Logout</a>
        </div>
    </nav>

    <!-- Main Page Shell -->
    <div style="max-width: 900px; margin: 0 auto; padding: 24px 20px 40px;">

        <!-- Header -->
        <div class="animate-fade-up" style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-weight: 800; margin-bottom: 8px; color: var(--text-dark);">
                Your Vision Board
            </h1>
            <p style="color: var(--text-light); font-size: 1.05rem;">
                Strategic plans and next steps for your journey.
            </p>
        </div>

        <!-- Timeline Container -->
        <div class="timeline-wrapper" id="timelineContainer">

            {% for plan in plans %}
            <div class="timeline-row" id="plan-row-{{ plan.id }}">
                <div class="timeline-marker"></div>

                <!-- Plan Card -->
                <div class="plan-card" id="plan-card-{{ plan.id }}" onclick="toggleBranchPanel('{{ plan.id }}')">

                    <!-- Card Header -->
                    <div class="plan-header">
                        <h3 class="plan-title">{{ plan.title }}</h3>
                        <div class="btn-icon-group">
                            <button
                                class="btn-icon-action"
                                onclick="openCloseConfirm(event, 'plan', '{{ plan.id }}', '{{ plan.title|escapejs }}')"
                                title="Close Plan">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Description -->
                    <p class="plan-desc">{{ plan.description }}</p>

                    <!-- Branches Panel (Collapsible) -->
                    <div
                        id="branch-panel-{{ plan.id }}"
                        class="branch-container"
                        onclick="event.stopPropagation()">

                        <!-- Threaded Branch List -->
                        <div class="branch-list" id="branches-list-{{ plan.id }}">
                            {% for branch in plan.branches.all %}
                            <div class="branch-item" id="branch-item-{{ branch.id }}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                                    <div class="branch-title">{{ branch.name }}</div>
                                    <button
                                        class="btn-icon-delete"
                                        onclick="openCloseConfirm(event, 'branch', '{{ branch.id }}', '{{ branch.name|escapejs }}')"
                                        title="Close Step">
                                        &times;
                                    </button>
                                </div>
                                <div class="branch-notes">{{ branch.notes }}</div>
                            </div>
                            {% empty %}
                            <div
                                id="no-branches-{{ plan.id }}"
                                style="padding: 12px; text-align: center; color: var(--text-light); font-style: italic;">
                                <i class="fas fa-seedling" style="margin-bottom: 6px; display: block;"></i>
                                No steps defined yet.
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Add Branch Button -->
                        <div style="margin-top: 16px; margin-left: 35px;">
                            <button
                                class="btn btn-sm btn-secondary"
                                onclick="toggleBranchForm('{{ plan.id }}')">
                                <i class="fas fa-plus"></i>
                                Add Step
                            </button>
                        </div>

                        <!-- Add Branch Form (Inline) -->
                        <div id="add-branch-form-{{ plan.id }}" class="inline-form-container">
                            <h4
                                style="margin-bottom: 12px; font-size: 0.95rem; color: var(--primary-color);">
                                Add New Step
                            </h4>
                            <form onsubmit="submitBranch(event, '{{ plan.id }}')">
                                <div class="form-group">
                                    <input
                                        type="text"
                                        name="branch_name"
                                        class="form-control"
                                        placeholder="Step Name (e.g., 'Buy Domain')"
                                        required>
                                </div>
                                <div class="form-group">
                                    <textarea
                                        name="branch_notes"
                                        class="form-control"
                                        rows="2"
                                        placeholder="Details or requirements..."></textarea>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button type="submit" class="btn btn-primary btn-sm">Save</button>
                                    <button
                                        type="button"
                                        class="btn btn-secondary btn-sm"
                                        onclick="toggleBranchForm('{{ plan.id }}')">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Bottom Toggle Bar -->
                    <div class="branch-toggle-bar">
                        <span>
                            <i class="fas fa-layer-group" style="margin-right: 6px;"></i>
                            {{ plan.branches.count }} Steps
                        </span>
                        <i class="fas fa-chevron-down chevron-icon"></i>
                    </div>

                </div>
            </div>
            {% empty %}
            <div
                style="text-align: center; padding: 50px 32px; color: var(--text-light); background: rgba(255,255,255,0.6); border-radius: 20px;">
                <i class="fas fa-lightbulb" style="font-size: 3rem; color: #ccc; margin-bottom: 18px;"></i>
                <h3 style="margin-bottom: 8px;">Ready to plan your future?</h3>
                <p style="margin: 0;">Click the button below to start your first master plan.</p>
            </div>
            {% endfor %}

        </div>

    </div>

    <!-- Floating Action Button for New Plan -->
    <button class="fab-add-plan" onclick="openPlanModal()" title="Add New Plan">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Add Plan Modal -->
    <div id="planModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create Vision Plan</h3>
                <span class="close-modal" onclick="closePlanModal()">&times;</span>
            </div>
            <form id="newPlanForm" onsubmit="submitPlan(event)">
                <div class="form-group">
                    <label class="form-label">Plan Title</label>
                    <input
                        type="text"
                        name="title"
                        class="form-control"
                        placeholder="e.g., Launch Startup"
                        required
                        style="font-size: 1.05rem; font-weight: 600;">
                </div>
                <div class="form-group">
                    <label class="form-label">Vision Description</label>
                    <textarea
                        name="description"
                        class="form-control"
                        rows="3"
                        placeholder="What is the ultimate goal?"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">
                        Create Plan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Close / Delete Confirmation Modal (Plans & Branches) -->
    <div id="closeConfirmModal" class="confirm-modal modal-warning">
        <div class="confirm-content">
            <div class="confirm-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="confirm-title" id="closeConfirmTitle">Close item?</h3>
            <p class="confirm-text" id="closeConfirmText">
                Are you sure you want to close this item? This action cannot be undone.
            </p>
            <div class="confirm-actions">
                <button type="button" class="confirm-btn-no" id="closeConfirmCancel">
                    Cancel
                </button>
                <button type="button" class="confirm-btn-yes" id="closeConfirmYes">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Auth & Config ---
        const csrfToken = '{{ csrf_token }}';

        // --- 1. UI Toggles ---

        function openPlanModal() {
            document.getElementById('planModal').classList.add('show');
        }

        function closePlanModal() {
            document.getElementById('planModal').classList.remove('show');
        }

        window.onclick = function(e) {
            if (e.target === document.getElementById('planModal')) {
                closePlanModal();
            }
        };

        // Expand/Collapse Branch Panel
        function toggleBranchPanel(planId) {
            const card = document.getElementById(`plan-card-${planId}`);
            const panel = document.getElementById(`branch-panel-${planId}`);

            card.classList.toggle('expanded');
            panel.classList.toggle('active');
        }

        // Toggle the Inline Branch Form
        function toggleBranchForm(planId) {
            const formDiv = document.getElementById(`add-branch-form-${planId}`);
            formDiv.classList.toggle('show');
        }

        // --- 2. API Logic (AJAX) ---

        async function submitPlan(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                title: form.title.value,
                description: form.description.value
            };

            try {
                const res = await fetch('{% url "add_plan_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });
                const json = await res.json();

                if (json.success) {
                    location.reload();
                } else {
                    alert('Error: ' + json.error);
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function submitBranch(e, planId) {
            e.preventDefault();
            const form = e.target;
            const data = {
                plan_id: planId,
                branch_name: form.branch_name.value,
                branch_notes: form.branch_notes.value
            };

            try {
                const res = await fetch('{% url "add_branch_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });
                const json = await res.json();

                if (json.success) {
                    location.reload();
                } else {
                    alert('Error: ' + json.error);
                }
            } catch (err) {
                console.error(err);
            }
        }

        // --- 3. Close / Delete Logic with Custom Modal ---

        let pendingClose = null;

        const closeConfirmModal = document.getElementById('closeConfirmModal');
        const closeConfirmTitle = document.getElementById('closeConfirmTitle');
        const closeConfirmText = document.getElementById('closeConfirmText');
        const closeConfirmCancel = document.getElementById('closeConfirmCancel');
        const closeConfirmYes = document.getElementById('closeConfirmYes');

        function openCloseConfirm(event, type, id, label) {
            event.stopPropagation();

            pendingClose = { type, id };

            const safeLabel = label || '';

            if (type === 'plan') {
                closeConfirmTitle.textContent = 'Close this plan?';
                closeConfirmText.textContent = safeLabel
                    ? `Are you sure you want to close the plan “${safeLabel}” and all its steps? This action cannot be undone.`
                    : 'Are you sure you want to close this plan and all its steps? This action cannot be undone.';
                closeConfirmYes.textContent = 'Close Plan';
            } else if (type === 'branch') {
                closeConfirmTitle.textContent = 'Close this step?';
                closeConfirmText.textContent = safeLabel
                    ? `Are you sure you want to close the step “${safeLabel}”? This action cannot be undone.`
                    : 'Are you sure you want to close this step? This action cannot be undone.';
                closeConfirmYes.textContent = 'Close Step';
            } else {
                closeConfirmTitle.textContent = 'Close item?';
                closeConfirmText.textContent =
                    'Are you sure you want to close this item? This action cannot be undone.';
                closeConfirmYes.textContent = 'Close';
            }

            closeConfirmModal.classList.add('show');
        }

        closeConfirmCancel.addEventListener('click', () => {
            closeConfirmModal.classList.remove('show');
            pendingClose = null;
        });

        closeConfirmYes.addEventListener('click', async () => {
            if (!pendingClose) {
                closeConfirmModal.classList.remove('show');
                return;
            }

            const { type, id } = pendingClose;
            const url = type === 'plan'
                ? '{% url "delete_plan_api" %}'
                : '{% url "delete_branch_api" %}';
            const body =
                type === 'plan'
                    ? { plan_id: id }
                    : { branch_id: id };

            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(body)
                });
                const json = await res.json();

                if (json.success) {
                    location.reload();
                } else if (json.error) {
                    alert('Error: ' + json.error);
                }
            } catch (err) {
                console.error(err);
            } finally {
                closeConfirmModal.classList.remove('show');
                pendingClose = null;
            }
        });

        // Close modal when clicking outside dialog
        closeConfirmModal.addEventListener('click', (e) => {
            if (e.target === closeConfirmModal) {
                closeConfirmModal.classList.remove('show');
                pendingClose = null;
            }
        });

        // --- 4. Navbar Scroll Effect ---
        let lastScroll = 0;
        const navbar = document.getElementById('mainNav');
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            if (currentScroll > lastScroll && currentScroll > 100) {
                navbar.classList.add('nav-hidden');
            } else {
                navbar.classList.remove('nav-hidden');
            }
            lastScroll = currentScroll;
        });
    </script>
</body>
</html>
