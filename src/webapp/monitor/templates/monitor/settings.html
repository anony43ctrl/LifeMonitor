<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - User Monitoring</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            padding-top: 0;
            overflow: hidden;
            background: #F2F2F7; 
        }
        
        .settings-header h2 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #000;
            margin: 0 0 5px 0;
        }
        
        .settings-header p {
            color: var(--text-light);
            margin-bottom: 25px;
        }

        .form-control {
            background: #F2F2F7;
            border: none;
            border-radius: 10px;
            padding: 14px;
            font-size: 16px;
        }
        .form-control:focus {
            background: #E5E5EA;
            box-shadow: none;
        }

        .ios-card {
            background: #fff;
            border-radius: 14px;
            border: 1px solid rgba(0,0,0,0.05);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        /* Responsive Grid for DB actions */
        .db-actions-grid {
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 24px;
        }

        @media (max-width: 900px) {
            .db-actions-grid { grid-template-columns: 1fr; }
        }

        .sys-row {
            display: flex;
            justify-content: space-between;
            padding: 14px 0;
            border-bottom: 1px solid #E5E5EA;
            font-size: 15px;
        }
        .sys-row:last-child { border-bottom: none; }
        .sys-key { color: var(--text-dark); font-weight: 500; }
        .sys-val { color: var(--text-secondary); }
        
        .sidebar-label {
            margin: 15px 0 5px 10px; 
            font-size: 12px; 
            font-weight: 700; 
            color: #8E8E93; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

    <nav class="navbar" id="mainNav">
        <div class="navbar-brand">LifeMonitor</div>
        <div class="nav-links">
            <a href="{% url 'home' %}" class="nav-item">Home</a>
            {% if user.is_authenticated %}
                <a href="{% url 'logout' %}" class="nav-item btn-logout">Logout</a>
            {% endif %}
        </div>
    </nav>

    <div class="settings-container">
        
        <div class="settings-sidebar" id="sidebar">
            <div class="sidebar-label">General</div>
            <button class="tab-link active" onclick="openTab(event, 'profile')">
                <i class="fas fa-user"></i> <span>Profile</span>
            </button>
            
            <div class="sidebar-label">Management</div>
            <button class="tab-link" onclick="openTab(event, 'database')">
                <i class="fas fa-database"></i> <span>Storage</span>
            </button>
            <button class="tab-link" onclick="openTab(event, 'about')">
                <i class="fas fa-info"></i> <span>System Info</span>
            </button>
            
            <div class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-chevron-left" id="toggleIcon"></i>
            </div>
        </div>

        <div class="settings-content">
            
            {% if messages %}
                <div style="margin-bottom: 25px;">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}" 
                             style="padding: 12px 16px; border-radius: 10px; margin-bottom: 10px; font-size: 14px; font-weight: 500;
                             {% if message.tags == 'error' %}background: #FFE5E5; color: #FF3B30;
                             {% elif message.tags == 'success' %}background: #E5F9E5; color: #34C759;
                             {% else %}background: #E5F0FF; color: #007AFF;{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div id="profile" class="tab-pane active">
                <div class="settings-header">
                    <h2>Account Settings</h2>
                    <p>Manage your login credentials and security.</p>
                </div>

                {% if user.is_authenticated %}
                    <form method="POST" class="ios-card">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_profile">
                        
                        <div class="form-group">
                            <label class="form-label">Username</label>
                            <input type="text" name="username" class="form-control" value="{{ user.username }}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" name="new_password" class="form-control" placeholder="••••••••">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" name="confirm_password" class="form-control" placeholder="••••••••">
                        </div>
                        <div style="margin-top: 20px; text-align: right;">
                            <button type="submit" class="btn btn-primary">Update Account</button>
                        </div>
                    </form>
                {% else %}
                    {% if account_exists %}
                        <div class="ios-card" style="text-align: center;">
                            <i class="fas fa-lock" style="font-size: 40px; color: #FF9500; margin-bottom: 15px;"></i>
                            <h3>Account Exists</h3>
                            <p style="color: #8E8E93; margin-bottom: 20px;">Registration is closed. Please login or reset.</p>
                            
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="reset_password">
                                <div class="form-group"><input type="text" name="username" class="form-control" placeholder="Username" required></div>
                                <div class="form-group"><input type="password" name="new_password" class="form-control" placeholder="New Password" required></div>
                                <div class="form-group"><input type="password" name="confirm_password" class="form-control" placeholder="Confirm Password" required></div>
                                <button type="submit" class="btn btn-primary btn-block">Reset Password</button>
                            </form>
                        </div>
                    {% else %}
                        <div class="ios-card">
                            <h3 style="margin-bottom: 20px;">Create Primary Account</h3>
                            <form method="POST">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="register">
                                <div class="form-group"><input type="text" name="username" class="form-control" placeholder="Username" required></div>
                                <div class="form-group"><input type="password" name="password" class="form-control" placeholder="Password" required></div>
                                <div class="form-group"><input type="password" name="confirm_password" class="form-control" placeholder="Confirm" required></div>
                                <button type="submit" class="btn btn-success btn-block">Create Account</button>
                            </form>
                        </div>
                    {% endif %}
                {% endif %}
            </div>

            <div id="database" class="tab-pane">
                <div class="settings-header">
                    <h2>Storage & Data</h2>
                    <p>Manage database sources and backups.</p>
                </div>

                <div class="ios-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; color: var(--text-dark);">Active Source</span>
                        <span class="badge badge-success">Connected</span>
                    </div>
                    <code style="display: block; background: #F2F2F7; padding: 10px; border-radius: 8px; font-size: 13px; color: #333; word-break: break-all;">
                        {{ current_db_path }}
                    </code>
                </div>

                <div class="db-actions-grid">
                    <div class="ios-card" style="display: flex; flex-direction: column;">
                        <h3 style="font-size: 17px; margin-bottom: 15px; color: #007AFF;">
                            <i class="fas fa-folder-open" style="margin-right: 8px;"></i> Load Database
                        </h3>
                        <p style="font-size: 14px; color: #8E8E93; margin-bottom: 20px; line-height: 1.4;">
                            Import an existing <code>.sqlite3</code> file.
                        </p>
                        
                        <form method="POST" enctype="multipart/form-data" id="switchForm" style="flex: 1; display: flex; flex-direction: column;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="switch_database">
                            
                            <div class="file-upload-wrapper" style="flex: 1;">
                                <input type="file" name="db_file" class="file-upload-input" accept="*/*" id="dbFileInput" onchange="updateFileName()">
                                <div style="pointer-events: none;">
                                    <i class="fas fa-cloud-upload-alt" style="font-size: 36px; color: #C7C7CC; margin-bottom: 10px;"></i>
                                    <div style="font-weight: 600; color: #007AFF;" id="fileNameDisplay">Tap to Browse</div>
                                </div>
                            </div>

                            <div style="margin-top: 20px;">
                                <button type="button" onclick="checkSwitch()" class="btn btn-secondary btn-block" style="color: #007AFF; font-weight: 600;">
                                    Load & Restart
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="ios-card">
                        <h3 style="font-size: 17px; margin-bottom: 15px; color: #34C759;">
                            <i class="fas fa-plus-circle" style="margin-right: 8px;"></i> Create New
                        </h3>
                        <p style="font-size: 14px; color: #8E8E93; margin-bottom: 20px; line-height: 1.4;">
                            Initialize a clean database.
                        </p>
                        
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="create_database">
                            
                            <div class="form-group">
                                <label class="form-label">Filename</label>
                                <input type="text" name="new_db_name" class="form-control" placeholder="new_tracker_v2">
                            </div>

                            <div style="margin-top: 20px;">
                                <button type="submit" class="btn btn-success btn-block" style="background: #34C759;">
                                    Initialize
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="about" class="tab-pane">
                <div class="settings-header">
                    <h2>About</h2>
                    <p>System diagnostics and version info.</p>
                </div>
                
                <div class="ios-card" style="padding: 0; overflow: hidden;">
                    <div style="padding: 0 20px;">
                        <div class="sys-row">
                            <span class="sys-key">Version</span>
                            <span class="sys-val">1.2.0</span>
                        </div>
                        <div class="sys-row">
                            <span class="sys-key">Framework</span>
                            <span class="sys-val">Django 5.1.1</span>
                        </div>
                        <div class="sys-row">
                            <span class="sys-key">Database Engine</span>
                            <span class="sys-val">SQLite3</span>
                        </div>
                        <div class="sys-row">
                            <span class="sys-key">Storage Mode</span>
                            <span class="sys-val">Local File System</span>
                        </div>
                        <div class="sys-row">
                            <span class="sys-key">Server Time</span>
                            <span class="sys-val">UTC</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="switchModal" class="confirm-modal modal-warning">
        <div class="confirm-content">
            <div class="confirm-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="confirm-title">Restart Session</h3>
            <p class="confirm-text">The session will restart and you will be requested with its respective password and username.</p>
            <div class="confirm-actions">
                <button type="button" class="confirm-btn-no" onclick="closeModal('switchModal')">Cancel</button>
                <button type="button" class="confirm-btn-yes" onclick="submitSwitch()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="missingFileModal" class="confirm-modal modal-error">
        <div class="confirm-content">
            <div class="confirm-icon"><i class="fas fa-file-excel"></i></div>
            <h3 class="confirm-title">No File Selected</h3>
            <p class="confirm-text">Please select a valid database file from your system before proceeding.</p>
            <div class="confirm-actions">
                <button type="button" class="confirm-btn-no" onclick="closeModal('missingFileModal')" style="width: 100%; color: #333;">Dismiss</button>
            </div>
        </div>
    </div>

    {% if setup_required %}
    <div id="setupModal" class="confirm-modal show" style="background: rgba(0,0,0,0.85);">
        <div class="confirm-content" style="width: 450px; max-width: 90%;">
            <div class="confirm-icon" style="background: var(--success-color);"><i class="fas fa-user-shield"></i></div>
            <h3 class="confirm-title">Initialize Admin</h3>
            <p class="confirm-text">Database created. Set up the admin user.</p>
            <form method="POST" class="styled-form">
                {% csrf_token %}
                <input type="hidden" name="action" value="setup_new_admin">
                <div style="text-align: left; margin-bottom: 20px;">
                    <div class="form-group"><input type="text" name="username" class="form-control" placeholder="Username" required></div>
                    <div class="form-group"><input type="password" name="password" class="form-control" placeholder="Password" required></div>
                    <div class="form-group"><input type="password" name="confirm_password" class="form-control" placeholder="Confirm Password" required></div>
                </div>
                <button type="submit" class="btn btn-success btn-block">Create & Sign Out</button>
            </form>
        </div>
    </div>
    {% endif %}

    <script>
        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('toggleIcon');
            sidebar.classList.toggle('collapsed');
            icon.className = sidebar.classList.contains('collapsed') ? 'fas fa-chevron-right' : 'fas fa-chevron-left';
        }

        // Tab Logic
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        // File Upload UI
        function updateFileName() {
            const input = document.getElementById('dbFileInput');
            const display = document.getElementById('fileNameDisplay');
            if (input.files.length > 0) {
                display.innerText = input.files[0].name;
                display.style.color = '#34C759'; // iOS Green
            } else {
                display.innerText = 'Tap to Browse';
                display.style.color = '#007AFF'; // iOS Blue
            }
        }

        // Modal Logic
        function closeModal(id) { 
            document.getElementById(id).classList.remove('show'); 
        }

        function checkSwitch() {
            const file = document.getElementById('dbFileInput').files.length;
            if(file === 0) {
                // Open Custom Error Modal
                document.getElementById('missingFileModal').classList.add('show');
                return;
            }
            document.getElementById('switchModal').classList.add('show');
        }

        function submitSwitch() { document.getElementById('switchForm').submit(); }
    </script>
</body>
</html>